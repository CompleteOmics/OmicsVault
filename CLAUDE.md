# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OmicsVault is a **dual-platform** lab inventory management system:
- **Web Application**: Next.js 14 web app with NextAuth session-based authentication
- **Mobile Application**: React Native (Expo) iOS/Android app with token-based authentication

Both platforms share the same PostgreSQL database and API backend, but use different authentication mechanisms.

## Architecture

### Dual Authentication System

This is critical to understand: the backend supports **two authentication methods simultaneously**:

1. **Web (NextAuth Sessions)**: Used by Next.js web app
   - Session-based via NextAuth.js
   - Cookie-based authentication
   - Configured in `lib/auth.ts`

2. **Mobile (HMAC Tokens)**: Used by React Native mobile app
   - Custom HMAC-SHA256 signed tokens
   - Token format: `base64(payload).hmac_signature`
   - Stored in device SecureStore
   - Generated by `/api/auth/mobile/signin`

**ALL API endpoints** must support both authentication methods using this pattern:

```typescript
import * as crypto from 'crypto'

function verifyMobileToken(token: string): string | null {
  try {
    const [payloadStr, signature] = token.split('.');
    if (!payloadStr || !signature) return null;

    const secret = process.env.NEXTAUTH_SECRET || 'mobile-secret-key';
    const expectedSignature = crypto
      .createHmac('sha256', secret)
      .update(payloadStr)
      .digest('base64');

    if (signature !== expectedSignature) return null;

    const payload = JSON.parse(Buffer.from(payloadStr, 'base64').toString());

    if (payload.exp < Date.now()) return null;

    return payload.userId;
  } catch {
    return null;
  }
}

export async function GET(request: NextRequest) {
  const session = await getServerSession(authOptions)
  let userId = session?.user?.id;

  // Check mobile auth if no session
  if (!userId) {
    const authHeader = request.headers.get('authorization');
    if (authHeader?.startsWith('Bearer ')) {
      const token = authHeader.split(' ')[1];
      userId = verifyMobileToken(token) || undefined;
    }
  }

  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // ... rest of endpoint
}
```

### Project Structure

```
omicsvault/
├── app/                      # Next.js App Router (web application)
│   ├── api/                 # API routes (shared by web + mobile)
│   │   ├── auth/
│   │   │   ├── [...nextauth]/route.ts    # NextAuth handler (web)
│   │   │   ├── mobile/signin/route.ts    # Mobile auth endpoint
│   │   │   ├── me/route.ts               # Current user (dual auth)
│   │   │   └── signup/route.ts           # User registration
│   │   ├── labs/[labId]/
│   │   │   ├── items/route.ts            # List/create items
│   │   │   ├── items/[itemId]/
│   │   │   │   ├── route.ts              # Get/update/delete item
│   │   │   │   ├── move/route.ts         # Move item to location
│   │   │   │   ├── qr/route.ts           # Generate QR code
│   │   │   │   └── photos/route.ts       # Upload photos
│   │   │   ├── locations/route.ts        # Locations CRUD
│   │   │   ├── activities/route.ts       # Activity feed
│   │   │   └── expiring/route.ts         # Expiration tracking
│   │   └── invites/                      # Invite system
│   ├── auth/                # Auth pages (signin/signup)
│   ├── dashboard/           # Web dashboard
│   └── labs/[labId]/        # Lab-specific pages
├── lib/
│   ├── auth.ts              # NextAuth configuration
│   └── prisma.ts            # Prisma client singleton
├── prisma/
│   ├── schema.prisma        # Database schema (single source of truth)
│   └── seed.ts              # Test data seeder
├── mobile/                   # React Native mobile app (Expo)
│   ├── src/
│   │   ├── screens/         # Screen components
│   │   │   ├── auth/        # SignIn/SignUp screens
│   │   │   ├── dashboard/   # Dashboard
│   │   │   ├── labs/        # Lab management
│   │   │   ├── items/       # Item list/detail/add
│   │   │   └── locations/   # Location management
│   │   ├── components/      # Reusable UI components
│   │   ├── services/
│   │   │   └── api.ts       # Axios API client (mobile auth)
│   │   ├── context/
│   │   │   └── AuthContext.tsx  # Zustand auth store
│   │   └── utils/
│   │       └── theme.ts     # Design system (colors, spacing)
│   ├── App.tsx              # Mobile app entry
│   └── package.json         # Mobile dependencies
└── public/uploads/          # Photo uploads (create manually)
```

## Commands

### Web Application

```bash
# Development
npm run dev              # Start Next.js dev server on :3000

# Build & Deploy
npm run build            # Production build
npm start                # Start production server

# Linting
npm run lint             # ESLint

# Database
npm run db:push          # Push Prisma schema to database (development)
npx prisma migrate dev   # Create migration (production-ready)
npx prisma generate      # Regenerate Prisma Client after schema changes
npm run db:studio        # Open Prisma Studio GUI
npm run db:seed          # Seed test data (creates test@test.com / test123)
```

### Mobile Application

```bash
cd mobile/

# Development
npm start                # Start Expo dev server
npx expo start           # Alternative (same as above)

# iOS (requires Xcode)
npx expo run:ios         # Build and run on iOS simulator
open -a Simulator        # Open iOS Simulator first

# Android (requires Android Studio)
npx expo run:android     # Build and run on Android emulator

# Simulator Management
xcrun simctl list devices  # List available iOS simulators
xcrun simctl boot "iPhone 16 Pro Max"  # Boot specific simulator
```

### Critical Post-Schema Commands

After ANY changes to `prisma/schema.prisma`:

```bash
# 1. Push schema to database
npx prisma db push

# 2. Regenerate Prisma Client
npx prisma generate

# 3. Restart backend dev server
# Stop npm run dev and restart it
```

If mobile app fails after schema changes, rebuild native modules:

```bash
cd mobile/
npx expo run:ios  # Force rebuild with new Prisma types
```

## Database Schema Patterns

### Key Models and Relationships

```
User (authentication & attribution)
  ↓
LabMember (role: ADMIN | MEMBER)
  ↓
Lab (workspace isolation)
  ↓
├─ Item (inventory)
│   ├─ Location (hierarchical, self-referencing)
│   ├─ Photo (gallery)
│   ├─ Movement (audit trail)
│   └─ Reservation (future use)
└─ Activity (activity feed, all actions)
```

### Important Schema Details

- **Hierarchical Locations**: Self-referencing via `parentId`
  ```prisma
  model Location {
    parentId   String?
    parent     Location?   @relation("LocationHierarchy", fields: [parentId], references: [id])
    children   Location[]  @relation("LocationHierarchy")
  }
  ```

- **Item Tracking**: Items track both creator and last updater
  ```prisma
  model Item {
    createdById     String
    createdBy       User   @relation("ItemCreator", fields: [createdById], references: [id])
    lastUpdatedById String?
    lastUpdatedBy   User?  @relation("ItemUpdater", fields: [lastUpdatedById], references: [id])
  }
  ```

- **Movement Audit**: Movements link from/to locations for full history
  ```prisma
  model Movement {
    fromLocationId String
    fromLocation   Location @relation("MovementFrom", fields: [fromLocationId], references: [id])
    toLocationId   String
    toLocation     Location @relation("MovementTo", fields: [toLocationId], references: [id])
  }
  ```

- **Activity Feed**: Uses enum `ActivityType` for type safety
  ```prisma
  enum ActivityType {
    ITEM_CREATED | ITEM_UPDATED | ITEM_DELETED | ITEM_MOVED
    QUANTITY_CHANGED | PHOTO_ADDED | LOCATION_CREATED
    MEMBER_JOINED | MEMBER_REMOVED
  }
  ```

## Development Workflows

### Adding a New API Endpoint

1. Create route file in `app/api/labs/[labId]/...`
2. **ALWAYS** implement dual authentication (see pattern above)
3. Verify lab membership if needed:
   ```typescript
   const membership = await prisma.labMember.findUnique({
     where: { userId_labId: { userId, labId: params.labId } }
   })
   if (!membership) {
     return NextResponse.json({ error: 'Not a member' }, { status: 403 })
   }
   ```
4. Log activities for user-facing actions:
   ```typescript
   await prisma.activity.create({
     data: {
       type: 'ITEM_CREATED',
       description: `${userName} added ${item.name}`,
       metadata: { itemId: item.id },
       labId: params.labId,
       userId: userId,
     },
   })
   ```
5. Test from both web app (session) and mobile app (token)

### Adding Mobile Screens

1. Create screen in `mobile/src/screens/`
2. Add route to navigation in `App.tsx`
3. Use API service from `mobile/src/services/api.ts`
4. Follow theme from `mobile/src/utils/theme.ts`
5. Test on both iOS simulator and Android emulator

### Debugging Mobile Authentication

If getting 401 errors from mobile:

1. Check token exists: `await SecureStore.getItemAsync('auth_token')`
2. Verify backend logs for token verification
3. Check `Authorization` header is sent: `Bearer ${token}`
4. Confirm endpoint has `verifyMobileToken()` function
5. Clear token and re-login: Uninstall/reinstall app

Common fix: Add missing mobile auth to endpoint (see pattern above)

## Key Technical Decisions

### Why Dual Auth?

- **Web**: NextAuth provides session management, OAuth providers, CSRF protection
- **Mobile**: Tokens work better on mobile (no cookies), persist in SecureStore

### Why HMAC Tokens Instead of JWT?

- Simpler implementation (no external library needed)
- HMAC-SHA256 provides same security as JWT
- Custom payload structure fits our needs
- Shares same secret as NextAuth (`NEXTAUTH_SECRET`)

### Photo Upload Strategy

- **Development**: Local filesystem in `public/uploads/`
- **Production**: Should migrate to S3/Cloudinary for scalability
- Files stored with `userId_timestamp_originalname.ext` pattern

### Mobile-Specific Considerations

- Camera unavailable on iOS simulator → Graceful error handling required
- Watchman required for Metro bundler file watching
- CocoaPods required for iOS native dependencies
- SecureStore for token persistence (encrypted on device)

## Test Data

Running `npm run db:seed` creates:

- **Users**:
  - `test@test.com` / `test123` (Admin of "Complete Omics Research Lab")
  - `researcher@omicsvault.com` / `password123` (Member)

- **Lab**: "Complete Omics Research Lab" with:
  - Hierarchical locations (Room 301 → Freezer → Shelf → Box)
  - Sample items (antibodies, reagents, buffers)
  - Activity history

## Common Issues

### "Unknown argument `expirationDate`" Error

**Cause**: Prisma Client out of sync with database schema

**Fix**:
```bash
npx prisma generate
npx prisma db push
# Restart backend server
```

### Mobile Auth 401 Errors

**Cause**: API endpoint missing mobile token verification

**Fix**: Add `verifyMobileToken()` pattern to endpoint (see Architecture section)

### iOS Build Fails with SDK Error

**Cause**: xcode-select pointing to CommandLineTools instead of Xcode.app

**Fix**:
```bash
sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
```

### Camera Crash on iOS Simulator

**Cause**: Simulator has no camera hardware

**Fix**: Always wrap camera calls in try-catch with user-friendly error message

### File Watching Limit Exceeded

**Cause**: Metro bundler exceeds system file watch limits

**Fix**:
```bash
brew install watchman
```

## Environment Variables

Required in `.env`:

```bash
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/omicsvault?schema=public"

# NextAuth (also used for mobile token signing)
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="generated-secret-here"  # openssl rand -base64 32

# App
NEXT_PUBLIC_APP_URL="http://localhost:3000"
```

For mobile development, update `mobile/src/services/api.ts` with your machine's IP:
```typescript
const API_BASE_URL = __DEV__
  ? 'http://YOUR-IP:3000/api'  // Not localhost, use actual IP
  : 'https://your-production-api.com/api';
```

## QR Code Workflow

QR codes encode: `${NEXT_PUBLIC_APP_URL}/labs/${labId}/items/${itemId}`

Intended usage:
1. Generate QR code from item detail page
2. Print and attach to physical lab item
3. Scan with mobile app camera to instantly open item details
4. Perfect for large labs with hundreds of items
